
FILE: docker-compose.yml


services:
  postgres:
    image: postgres:16-alpine
    container_name: supercomputers-db
    environment:
      POSTGRES_DB: supercomputers
      POSTGRES_USER: superuser
      POSTGRES_PASSWORD: superpass
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superuser -d supercomputers"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:



FILE: pom.xml


<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.5.9</version>
		<relativePath/>
	</parent>
	<groupId>com.utmn.shanaurin</groupId>
	<artifactId>supercomputers</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>supercomputers</name>
	<description>Supercomputers management system</description>

	<properties>
		<java.version>21</java.version>
		<mainClass>com.utmn.shanaurin.supercomputers.SupercomputersApplication</mainClass>
		<testcontainers.version>1.20.4</testcontainers.version>
	</properties>

	<dependencies>
		<!-- Web -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<!-- JPA -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>

		<!-- Security -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>

		<!-- Thymeleaf –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-thymeleaf</artifactId>
		</dependency>

		<!-- PostgreSQL -->
		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<!-- Flyway –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π -->
		<dependency>
			<groupId>org.flywaydb</groupId>
			<artifactId>flyway-core</artifactId>
		</dependency>
		<dependency>
			<groupId>org.flywaydb</groupId>
			<artifactId>flyway-database-postgresql</artifactId>
		</dependency>

		<!-- Lombok -->
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<version>1.18.38</version>
		</dependency>

		<!-- OpenAPI / Swagger -->
		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.5</version>
		</dependency>

		<!-- CSV -->
		<dependency>
			<groupId>com.opencsv</groupId>
			<artifactId>opencsv</artifactId>
			<version>5.12.0</version>
		</dependency>

		<!-- Validation -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation</artifactId>
		</dependency>

		<!-- Commons BeanUtils -->
		<dependency>
			<groupId>commons-beanutils</groupId>
			<artifactId>commons-beanutils</artifactId>
			<version>1.11.0</version>
			<exclusions>
				<exclusion>
					<groupId>commons-logging</groupId>
					<artifactId>commons-logging</artifactId>
				</exclusion>
			</exclusions>
		</dependency>

		<!-- Test -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<scope>test</scope>
		</dependency>

		<!-- Testcontainers -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-testcontainers</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.testcontainers</groupId>
			<artifactId>junit-jupiter</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.testcontainers</groupId>
			<artifactId>postgresql</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.testcontainers</groupId>
				<artifactId>testcontainers-bom</artifactId>
				<version>${testcontainers.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>
</project>


FILE: README.md


# s5-netology-backend

https://www.kaggle.com/datasets/ramjasmaurya/top-ranked-supercomputer-2021	–°—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä—ã	supecomputer 2021.csv



FILE: .mvn\wrapper\maven-wrapper.properties


wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip



FILE: src\main\java\com\utmn\shanaurin\supercomputers\SupercomputersApplication.java


package com.utmn.shanaurin.supercomputers;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

import java.util.UUID;

@SpringBootApplication
public class SupercomputersApplication {

	public static void main(String[] args) {
		SpringApplication.run(SupercomputersApplication.class, args);
	}

}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\config\OpenApiConfig.java


package com.utmn.shanaurin.supercomputers.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Contact;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.servers.Server;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("Supercomputers API")
                        .version("1.0.0")
                        .description("REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ –æ —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö TOP500")
                        .contact(new Contact()
                                .name("Shanaurin")
                                .email("shanaurin@utmn.ru")))
                .servers(List.of(
                        new Server().url("http://localhost:8080").description("Development server")
                ));
    }
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\config\SecurityConfig.java


package com.utmn.shanaurin.supercomputers.config;

import com.utmn.shanaurin.supercomputers.security.JpaUserDetailsService;
import com.utmn.shanaurin.supercomputers.security.PersonRepository;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public UserDetailsService jpaUserDetailsService(
            PersonRepository personRepository,
            BCryptPasswordEncoder encoder) {
        return new JpaUserDetailsService(personRepository, encoder);
    }

    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/admin/**").hasRole("ADMIN")
                        .requestMatchers("/api/**").hasAnyRole("ADMIN", "USER")
                        .requestMatchers("/swagger-ui/**", "/v3/api-docs/**", "/swagger-ui.html").permitAll()
                        .requestMatchers("/", "/index.html", "/css/**", "/js/**").permitAll()
                        .requestMatchers("/login/**").permitAll()
                        .requestMatchers("/actuator/**").permitAll()
                        .anyRequest().permitAll()
                )
                .httpBasic(Customizer.withDefaults());

        return http.build();
    }
}


FILE: src\main\java\com\utmn\shanaurin\supercomputers\controller\SupercomputerController.java


package com.utmn.shanaurin.supercomputers.controller;

import com.utmn.shanaurin.supercomputers.model.Supercomputer;
import com.utmn.shanaurin.supercomputers.service.SupercomputerService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/supercomputers")
@Tag(name = "Supercomputers", description = "API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º–∏")
public class SupercomputerController {

    private final SupercomputerService service;

    public SupercomputerController(SupercomputerService service) {
        this.service = service;
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä—ã",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤. –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä—ë–º–µ –¥–∞–Ω–Ω—ã—Ö.")
    @GetMapping
    public Iterable<Supercomputer> getAll() {
        return service.getAll();
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä –ø–æ ID")
    @GetMapping("/{id}")
    public Supercomputer getOne(
            @Parameter(description = "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–∞")
            @PathVariable("id") String id
    ) {
        return service.getOne(id);
    }

    @Operation(summary = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä")
    @PostMapping
    public ResponseEntity<Supercomputer> add(@RequestBody Supercomputer supercomputer) {
        Supercomputer created = service.add(supercomputer);
        return new ResponseEntity<>(created, HttpStatus.CREATED);
    }

    @Operation(summary = "–û–±–Ω–æ–≤–∏—Ç—å —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @PutMapping
    public void update(@RequestBody Supercomputer supercomputer) {
        service.update(supercomputer);
    }

    @Operation(summary = "–£–¥–∞–ª–∏—Ç—å —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @DeleteMapping("/{id}")
    public void delete(
            @Parameter(description = "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–∞")
            @PathVariable("id") String id
    ) {
        service.delete(id);
    }

    @Operation(summary = "–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ Rmax (TFlop/s) –ø–æ –≤—Å–µ–º —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º")
    @GetMapping("/stats/avg-performance")
    public Double avgPerformance() {
        return service.avgPerformance();
    }

    @Operation(summary = "–°—Ä–µ–¥–Ω—è—è –º–æ—â–Ω–æ—Å—Ç—å",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ (–∫–í—Ç)")
    @GetMapping("/stats/avg-power")
    public Double avgPower() {
        return service.avgPower();
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –ø–æ —Å—Ç—Ä–∞–Ω–µ")
    @GetMapping("/country/{country}")
    public List<Supercomputer> getByCountry(
            @Parameter(description = "–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã")
            @PathVariable("country") String country
    ) {
        return service.getByCountry(country);
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –ø–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—É")
    @GetMapping("/continent/{continent}")
    public List<Supercomputer> getByContinent(
            @Parameter(description = "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–∞")
            @PathVariable("continent") String continent
    ) {
        return service.getByContinent(continent);
    }

    @Operation(summary = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–∞–º",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –ø–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–∞–º")
    @GetMapping("/stats/by-continent")
    public Map<String, Long> countByContinent() {
        return service.countByContinent();
    }
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\controller\WebController.java


package com.utmn.shanaurin.supercomputers.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class WebController {

    @GetMapping("/")
    public String index() {
        return "index";
    }
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\model\Supercomputer.java


package com.utmn.shanaurin.supercomputers.model;

import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;

@Entity
@Table(name = "supercomputer")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Supercomputer {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @org.hibernate.annotations.UuidGenerator
    private String id;

    @Column
    private Integer rank;

    @Column(name = "previous_rank")
    private Integer previousRank;

    @Column(length = 255)
    private String name;

    @Column(name = "system_model", length = 500)
    private String systemModel;

    @Column(length = 100)
    private String manufacturer;

    @Column(length = 100)
    private String country;

    @Column
    private Integer year;

    @Column(length = 50)
    private String segment;

    @Column(name = "total_cores")
    private Integer totalCores;

    @Column(name = "accelerator_cores")
    private Integer acceleratorCores;

    @Column(name = "rmax_tflops")
    private Double rmaxTflops;

    @Column(name = "rpeak_tflops")
    private Double rpeakTflops;

    @Column(name = "power_kw")
    private Double powerKw;

    @Column(name = "power_efficiency")
    private Double powerEfficiency;

    @Column(length = 50)
    private String architecture;

    @Column(name = "processor_technology", length = 100)
    private String processorTechnology;

    @Column(name = "processor_speed_mhz")
    private Integer processorSpeedMhz;

    @Column(name = "operating_system", length = 100)
    private String operatingSystem;

    @Column(name = "os_family", length = 50)
    private String osFamily;

    @Column(length = 100)
    private String accelerator;

    @Column(name = "cores_per_socket")
    private Integer coresPerSocket;

    @Column(name = "system_family", length = 100)
    private String systemFamily;

    @Column(length = 50)
    private String continent;
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\repository\SupercomputerJpaRepository.java


package com.utmn.shanaurin.supercomputers.repository;

import com.utmn.shanaurin.supercomputers.model.Supercomputer;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.CrudRepository;

import java.util.List;

public interface SupercomputerJpaRepository extends CrudRepository<Supercomputer, String> {

    // Native SQL
    @Query(value = "SELECT AVG(s.rmax_tflops) FROM supercomputer s", nativeQuery = true)
    Double avgPerformance();

    // JPQL
    @Query("SELECT AVG(s.rmaxTflops) FROM Supercomputer s")
    Double getAvgPerformance();

    // –ù–∞–π—Ç–∏ –ø–æ —Å—Ç—Ä–∞–Ω–µ
    List<Supercomputer> findByCountryIgnoreCase(String country);

    // –ù–∞–π—Ç–∏ –ø–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—É
    List<Supercomputer> findByContinentIgnoreCase(String continent);

    // –¢–æ–ø N –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    @Query("SELECT s FROM Supercomputer s ORDER BY s.rmaxTflops DESC")
    List<Supercomputer> findTopByPerformance();

    // –°—Ä–µ–¥–Ω—è—è –º–æ—â–Ω–æ—Å—Ç—å
    @Query("SELECT AVG(s.powerKw) FROM Supercomputer s WHERE s.powerKw IS NOT NULL")
    Double getAvgPower();

    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–∞–º
    @Query("SELECT s.continent, COUNT(s) FROM Supercomputer s GROUP BY s.continent")
    List<Object[]> countByContinent();
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\security\JpaUserDetailsService.java


package com.utmn.shanaurin.supercomputers.security;

import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;

public class JpaUserDetailsService implements UserDetailsService {

    private final PersonRepository personRepository;
    private final PasswordEncoder encoder;

    public JpaUserDetailsService(PersonRepository personRepository, PasswordEncoder encoder) {
        this.personRepository = personRepository;
        this.encoder = encoder;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Person person = personRepository.findByEmailIgnoreCase(username);
        if (person != null) {
            String encodedPassword = encoder.encode(person.getPassword());
            return User.withUsername(person.getEmail())
                    .accountLocked(!person.isEnabled())
                    .password(encodedPassword)
                    .roles(person.getRole())
                    .build();
        }
        throw new UsernameNotFoundException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: " + username);
    }
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\security\Person.java


package com.utmn.shanaurin.supercomputers.security;

import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "person")
@Data
@NoArgsConstructor
public class Person {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(unique = true, nullable = false)
    private String email;

    private String name;

    private LocalDate birthday;

    private String password;

    private boolean enabled = true;

    private String role = "USER";

    @Column(insertable = true, updatable = false)
    private LocalDateTime created;

    @Column(name = "modified")
    private LocalDateTime updated;

    public Person(String email, String name, LocalDate birthday, String password, boolean enabled, String role) {
        this.email = email;
        this.name = name;
        this.birthday = birthday;
        this.password = password;
        this.enabled = enabled;
        this.role = role;
    }

    public Person(String email, String name, LocalDate birthday, String password) {
        this.email = email;
        this.name = name;
        this.birthday = birthday;
        this.password = password;
    }

    @PrePersist
    void onCreate() {
        created = LocalDateTime.now();
        updated = LocalDateTime.now();
    }

    @PreUpdate
    void onUpdate() {
        updated = LocalDateTime.now();
    }
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\security\PersonRepository.java


package com.utmn.shanaurin.supercomputers.security;

import org.springframework.data.repository.CrudRepository;
import org.springframework.data.repository.query.Param;

public interface PersonRepository extends CrudRepository<Person, String> {

    Person findByEmailIgnoreCase(@Param("email") String email);
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\service\DataInitializerService.java


package com.utmn.shanaurin.supercomputers.service;

import com.opencsv.CSVReader;
import com.opencsv.CSVReaderBuilder;
import com.opencsv.exceptions.CsvException;
import com.utmn.shanaurin.supercomputers.model.Supercomputer;
import com.utmn.shanaurin.supercomputers.repository.SupercomputerJpaRepository;
import jakarta.annotation.PostConstruct;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@Service
public class DataInitializerService {

    private static final Logger log = LoggerFactory.getLogger(DataInitializerService.class);

    private final SupercomputerJpaRepository repository;

    @Value("${app.data.init-from-csv:true}")
    private boolean initFromCsv;

    @Value("${app.data.csv-path:classpath:supercomputers.csv}")
    private Resource csvResource;

    public DataInitializerService(SupercomputerJpaRepository repository) {
        this.repository = repository;
    }

    @PostConstruct
    public void init() {
        if (!initFromCsv) {
            log.info("CSV initialization is disabled");
            return;
        }

        long count = repository.count();
        if (count > 0) {
            log.info("Database already contains {} supercomputers, skipping CSV import", count);
            return;
        }

        log.info("Database is empty, starting CSV import...");
        loadDataFromCsv();
    }

    @Transactional
    public void loadDataFromCsv() {
        try {
            List<Supercomputer> supercomputers = parseCsvFile();
            repository.saveAll(supercomputers);
            log.info("Successfully imported {} supercomputers from CSV", supercomputers.size());
        } catch (Exception e) {
            log.error("Failed to import data from CSV", e);
            throw new RuntimeException("CSV import failed", e);
        }
    }

    private List<Supercomputer> parseCsvFile() throws IOException, CsvException {
        List<Supercomputer> result = new ArrayList<>();

        try (BufferedReader reader = new BufferedReader(new InputStreamReader(csvResource.getInputStream()));
             CSVReader csvReader = new CSVReaderBuilder(reader)
                     .withSkipLines(1) // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                     .build()) {

            List<String[]> lines = csvReader.readAll();

            for (String[] line : lines) {
                if (line.length < 23) {
                    log.warn("Skipping malformed CSV line with {} columns", line.length);
                    continue;
                }

                Supercomputer sc = new Supercomputer();
//                sc.setId(UUID.randomUUID().toString());
                sc.setRank(parseInteger(line[0]));
                sc.setPreviousRank(parseInteger(line[1]));
                sc.setName(line[2]);
                sc.setSystemModel(line[3]);
                sc.setManufacturer(line[4]);
                sc.setCountry(line[5]);
                sc.setYear(parseInteger(line[6]));
                sc.setSegment(line[7]);
                sc.setTotalCores(parseInteger(line[8]));
                sc.setAcceleratorCores(parseInteger(line[9]));
                sc.setRmaxTflops(parseDouble(line[10]));
                sc.setRpeakTflops(parseDouble(line[11]));
                sc.setPowerKw(parseDouble(line[12]));
                sc.setPowerEfficiency(parseDouble(line[13]));
                sc.setArchitecture(line[14]);
                sc.setProcessorTechnology(line[15]);
                sc.setProcessorSpeedMhz(parseInteger(line[16]));
                sc.setOperatingSystem(line[17]);
                sc.setOsFamily(line[18]);
                sc.setAccelerator(line[19]);
                sc.setCoresPerSocket(parseInteger(line[20]));
                sc.setSystemFamily(line[21]);
                sc.setContinent(line[22]);

                result.add(sc);
            }
        }

        return result;
    }

    private Integer parseInteger(String value) {
        if (value == null || value.isBlank()) return null;
        try {
            return Integer.parseInt(value.trim());
        } catch (NumberFormatException e) {
            return null;
        }
    }

    private Double parseDouble(String value) {
        if (value == null || value.isBlank()) return null;
        try {
            return Double.parseDouble(value.trim());
        } catch (NumberFormatException e) {
            return null;
        }
    }

    /**
     * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π)
     */
    @Transactional
    public void reloadDataFromCsv() {
        log.info("Force reloading data from CSV...");
        repository.deleteAll();
        loadDataFromCsv();
    }
}



FILE: src\main\java\com\utmn\shanaurin\supercomputers\service\SupercomputerService.java


package com.utmn.shanaurin.supercomputers.service;

import com.utmn.shanaurin.supercomputers.model.Supercomputer;
import com.utmn.shanaurin.supercomputers.repository.SupercomputerJpaRepository;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.server.ResponseStatusException;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@Transactional(readOnly = true)
public class SupercomputerService {

    private final SupercomputerJpaRepository repository;

    public SupercomputerService(SupercomputerJpaRepository repository) {
        this.repository = repository;
    }

    public Iterable<Supercomputer> getAll() {
        return repository.findAll();
    }

    public Supercomputer getOne(String id) {
        return repository.findById(id)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "–°—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    }

    @Transactional
    public Supercomputer add(Supercomputer supercomputer) {
        supercomputer.setId(null); // –ü–æ–∑–≤–æ–ª—è–µ–º JPA –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ID
        return repository.save(supercomputer);
    }

    @Transactional
    public void update(Supercomputer supercomputer) {
        if (!repository.existsById(supercomputer.getId())) {
            throw new ResponseStatusException(HttpStatus.NOT_FOUND, "–°—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }
        repository.save(supercomputer);
    }

    @Transactional
    public void delete(String id) {
        if (!repository.existsById(id)) {
            throw new ResponseStatusException(HttpStatus.NOT_FOUND, "–°—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }
        repository.deleteById(id);
    }

    public Double avgPerformance() {
        return repository.getAvgPerformance();
    }

    public Double avgPower() {
        return repository.getAvgPower();
    }

    public List<Supercomputer> getByCountry(String country) {
        return repository.findByCountryIgnoreCase(country);
    }

    public List<Supercomputer> getByContinent(String continent) {
        return repository.findByContinentIgnoreCase(continent);
    }

    public Map<String, Long> countByContinent() {
        return repository.countByContinent().stream()
                .collect(Collectors.toMap(
                        arr -> (String) arr[0],
                        arr -> (Long) arr[1]
                ));
    }

    public long count() {
        return repository.count();
    }
}


FILE: src\main\resources\application-test.properties


# Test configuration (Testcontainers change datasource)
spring.jpa.hibernate.ddl-auto=validate
spring.flyway.enabled=true
app.data.init-from-csv=true
spring.jpa.show-sql=true
logging.level.org.testcontainers=INFO
logging.level.com.utmn.shanaurin.supercomputers=DEBUG


FILE: src\main\resources\application.properties


spring.application.name=supercomputers

# PostgreSQL - Default values, can be changed from env data
spring.datasource.url=${DB_URL:jdbc:postgresql://localhost:5433/supercomputers}
spring.datasource.username=${DB_USERNAME:superuser}
spring.datasource.password=${DB_PASSWORD:superpass}
spring.datasource.driver-class-name=org.postgresql.Driver

# HikariCP connection pool
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=2
spring.datasource.hikari.idle-timeout=30000

# JPA/Hibernate
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=${SHOW_SQL:false}
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.open-in-view=false

# Flyway
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true

# Init from CSV
app.data.init-from-csv=${INIT_CSV:true}
app.data.csv-path=classpath:supercomputers.csv

# Logging
logging.level.org.springframework.data=INFO
logging.level.org.flywaydb=INFO
logging.level.com.utmn.shanaurin.supercomputers=DEBUG

# OpenAPI
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.path=/swagger-ui.html

# Server
server.port=${SERVER_PORT:8080}


FILE: src\main\resources\templates\index.html


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supercomputers API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #888;
            font-size: 1.1em;
        }

        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section h2 {
            color: #00d9ff;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .endpoint {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .endpoint:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,217,255,0.2);
        }

        .method {
            padding: 6px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85em;
            min-width: 70px;
            text-align: center;
            margin-right: 15px;
        }

        .method.get { background: #10B981; }
        .method.post { background: #3B82F6; }
        .method.put { background: #F59E0B; }
        .method.delete { background: #EF4444; }

        .endpoint-info {
            flex: 1;
        }

        .endpoint-path {
            font-family: 'Courier New', monospace;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .endpoint-desc {
            color: #888;
            font-size: 0.9em;
        }

        .try-btn {
            padding: 8px 16px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border: none;
            border-radius: 5px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .try-btn:hover {
            opacity: 0.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(0,217,255,0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(0,217,255,0.3);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
        }

        .response-area {
            background: #0d0d0d;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .response-area.active {
            display: block;
        }

        .response-area pre {
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .quick-links {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .quick-link {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            transition: all 0.2s;
        }

        .quick-link:hover {
            background: rgba(0,217,255,0.2);
            border-color: #00d9ff;
        }

        .auth-info {
            background: rgba(255,193,7,0.1);
            border: 1px solid rgba(255,193,7,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .auth-info h3 {
            color: #FFC107;
            margin-bottom: 10px;
        }

        .credentials {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .credential {
            font-family: 'Courier New', monospace;
        }

        .credential-role {
            color: #888;
            font-size: 0.85em;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #00d9ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üñ•Ô∏è Supercomputers API</h1>
        <p class="subtitle">REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ –æ —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö TOP500</p>

        <div class="quick-links">
            <a href="/swagger-ui.html" class="quick-link">üìö Swagger UI</a>
            <a href="/v3/api-docs" class="quick-link">üìÑ OpenAPI JSON</a>
        </div>
    </header>

    <div class="auth-info">
        <h3>üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Basic Auth)</h3>
        <div class="credentials">
            <div class="credential">
                <span class="credential-role">USER:</span> user / userPass
            </div>
            <div class="credential">
                <span class="credential-role">ADMIN:</span> admin / adminPass
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-count">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg-perf">-</div>
                <div class="stat-label">–°—Ä. –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (TFlop/s)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg-power">-</div>
                <div class="stat-label">–°—Ä. –º–æ—â–Ω–æ—Å—Ç—å (–∫–í—Ç)</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üîó CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>

        <div class="endpoint" onclick="tryEndpoint('GET', '/api/supercomputers')">
            <span class="method get">GET</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers</div>
                <div class="endpoint-desc">–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤</div>
            </div>
            <button class="try-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
        </div>

        <div class="endpoint" onclick="tryEndpoint('GET', '/api/supercomputers/{id}')">
            <span class="method get">GET</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers/{id}</div>
                <div class="endpoint-desc">–ü–æ–ª—É—á–∏—Ç—å —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä –ø–æ ID</div>
            </div>
            <button class="try-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
        </div>

        <div class="endpoint">
            <span class="method post">POST</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers</div>
                <div class="endpoint-desc">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä</div>
            </div>
        </div>

        <div class="endpoint">
            <span class="method put">PUT</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers</div>
                <div class="endpoint-desc">–û–±–Ω–æ–≤–∏—Ç—å —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä</div>
            </div>
        </div>

        <div class="endpoint">
            <span class="method delete">DELETE</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers/{id}</div>
                <div class="endpoint-desc">–£–¥–∞–ª–∏—Ç—å —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üìà –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã</h2>

        <div class="endpoint" onclick="tryEndpoint('GET', '/api/supercomputers/stats/avg-performance')">
            <span class="method get">GET</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers/stats/avg-performance</div>
                <div class="endpoint-desc">–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (Rmax TFlop/s)</div>
            </div>
            <button class="try-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
        </div>

        <div class="endpoint" onclick="tryEndpoint('GET', '/api/supercomputers/stats/avg-power')">
            <span class="method get">GET</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers/stats/avg-power</div>
                <div class="endpoint-desc">–°—Ä–µ–¥–Ω—è—è –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–∞—è –º–æ—â–Ω–æ—Å—Ç—å</div>
            </div>
            <button class="try-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
        </div>

        <div class="endpoint" onclick="tryEndpoint('GET', '/api/supercomputers/stats/by-continent')">
            <span class="method get">GET</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers/stats/by-continent</div>
                <div class="endpoint-desc">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–∞–º</div>
            </div>
            <button class="try-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
        </div>

        <div class="endpoint" onclick="tryEndpoint('GET', '/api/supercomputers/country/Japan')">
            <span class="method get">GET</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers/country/{country}</div>
                <div class="endpoint-desc">–ü–æ–ª—É—á–∏—Ç—å –ø–æ —Å—Ç—Ä–∞–Ω–µ (–ø—Ä–∏–º–µ—Ä: Japan)</div>
            </div>
            <button class="try-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
        </div>

        <div class="endpoint" onclick="tryEndpoint('GET', '/api/supercomputers/continent/Asia')">
            <span class="method get">GET</span>
            <div class="endpoint-info">
                <div class="endpoint-path">/api/supercomputers/continent/{continent}</div>
                <div class="endpoint-desc">–ü–æ–ª—É—á–∏—Ç—å –ø–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—É (–ø—Ä–∏–º–µ—Ä: Asia)</div>
            </div>
            <button class="try-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <div class="section">
        <h2>üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</h2>
        <div class="response-area active" id="response">
            <pre>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç–≤–µ—Ç...</pre>
        </div>
    </div>
</div>

<script>
    const credentials = btoa('user:userPass');

    async function tryEndpoint(method, path) {
        const responseArea = document.getElementById('response');
        responseArea.innerHTML = '<div class="loading"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            const response = await fetch(path, {
                method: method,
                headers: {
                    'Authorization': 'Basic ' + credentials,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            responseArea.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        } catch (error) {
            responseArea.innerHTML = '<pre style="color: #EF4444;">–û—à–∏–±–∫–∞: ' + error.message + '</pre>';
        }
    }

    async function loadStats() {
        try {
            const allResponse = await fetch('/api/supercomputers', {
                headers: { 'Authorization': 'Basic ' + credentials }
            });
            const all = await allResponse.json();
            document.getElementById('stat-count').textContent = Array.isArray(all) ? all.length : '-';

            const avgPerfResponse = await fetch('/api/supercomputers/stats/avg-performance', {
                headers: { 'Authorization': 'Basic ' + credentials }
            });
            const avgPerf = await avgPerfResponse.json();
            document.getElementById('stat-avg-perf').textContent =
                avgPerf ? avgPerf.toFixed(2) : '-';

            const avgPowerResponse = await fetch('/api/supercomputers/stats/avg-power', {
                headers: { 'Authorization': 'Basic ' + credentials }
            });
            const avgPower = await avgPowerResponse.json();
            document.getElementById('stat-avg-power').textContent =
                avgPower ? avgPower.toFixed(2) : '-';

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadStats);
</script>
</body>
</html>


FILE: src\test\java\com\utmn\shanaurin\supercomputers\BaseIntegrationTest.java


package com.utmn.shanaurin.supercomputers;

import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Testcontainers;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Testcontainers
public abstract class BaseIntegrationTest {

    /**
     * –û–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤—Å—é JVM (singleton).
     * –í—Å–µ —Ç–µ—Å—Ç-–∫–ª–∞—Å—Å—ã, –Ω–∞—Å–ª–µ–¥—É—é—â–∏–µ BaseIntegrationTest, –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ Postgres –∏ –ø–æ—Ä—Ç.
     */
    private static final PostgreSQLContainer<?> POSTGRES = SingletonPostgresContainer.getInstance();

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", POSTGRES::getJdbcUrl);
        registry.add("spring.datasource.username", POSTGRES::getUsername);
        registry.add("spring.datasource.password", POSTGRES::getPassword);

        registry.add("spring.flyway.enabled", () -> "true");
        registry.add("app.data.init-from-csv", () -> "true");
    }

    /**
     * Singleton-–æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ PostgreSQLContainer.
     * –í–∞–∂–Ω–æ: —Å—Ç–∞—Ä—Ç—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑, –∏ –æ–Ω –∂–∏–≤—ë—Ç –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è JVM (test run).
     */
    static final class SingletonPostgresContainer {

        private static final PostgreSQLContainer<?> INSTANCE =
                new PostgreSQLContainer<>("postgres:16-alpine")
                        .withDatabaseName("supercomputers_test")
                        .withUsername("test")
                        .withPassword("test");

        static {
            INSTANCE.start();
        }

        static PostgreSQLContainer<?> getInstance() {
            return INSTANCE;
        }

        private SingletonPostgresContainer() {
        }
    }
}


FILE: src\test\java\com\utmn\shanaurin\supercomputers\SupercomputersApplicationTests.java


package com.utmn.shanaurin.supercomputers;

import com.utmn.shanaurin.supercomputers.service.SupercomputerService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;

import static org.assertj.core.api.Assertions.assertThat;

class SupercomputersApplicationTests extends BaseIntegrationTest {

	@Autowired
	private SupercomputerService supercomputerService;

	@Test
	void contextLoads() {
		assertThat(supercomputerService).isNotNull();
	}

	@Test
	void dataLoadedFromCsv() {
		long count = supercomputerService.count();
		assertThat(count).isGreaterThan(0);
	}

	@Test
	void avgPerformanceCalculated() {
		Double avgPerformance = supercomputerService.avgPerformance();
		assertThat(avgPerformance).isNotNull().isGreaterThan(0);
	}
}



FILE: src\test\java\com\utmn\shanaurin\supercomputers\controller\SupercomputerControllerIntegrationTest.java


package com.utmn.shanaurin.supercomputers.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.utmn.shanaurin.supercomputers.BaseIntegrationTest;
import com.utmn.shanaurin.supercomputers.model.Supercomputer;
import com.utmn.shanaurin.supercomputers.repository.SupercomputerJpaRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.http.MediaType;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.transaction.annotation.Transactional;

import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@AutoConfigureMockMvc
class SupercomputerControllerIntegrationTest extends BaseIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private SupercomputerJpaRepository repository;

    @Test
    @WithMockUser(roles = "USER")
    void getAllSupercomputers_shouldReturnList() throws Exception {
        mockMvc.perform(get("/api/supercomputers"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasSize(greaterThan(0))));
    }

    @Test
    @WithMockUser(roles = "USER")
    void getByCountry_shouldReturnFilteredList() throws Exception {
        mockMvc.perform(get("/api/supercomputers/country/Japan"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$[*].country", everyItem(equalToIgnoringCase("Japan"))));
    }

    @Test
    @WithMockUser(roles = "USER")
    void getByContinent_shouldReturnFilteredList() throws Exception {
        mockMvc.perform(get("/api/supercomputers/continent/Asia"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$[*].continent", everyItem(equalToIgnoringCase("Asia"))));
    }

    @Test
    @WithMockUser(roles = "USER")
    void getAvgPerformance_shouldReturnValue() throws Exception {
        mockMvc.perform(get("/api/supercomputers/stats/avg-performance"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", greaterThan(0.0)));
    }

    @Test
    @WithMockUser(roles = "USER")
    void getCountByContinent_shouldReturnMap() throws Exception {
        mockMvc.perform(get("/api/supercomputers/stats/by-continent"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.Asia", greaterThan(0)))
                .andExpect(jsonPath("$.Europe", greaterThan(0)));
    }

    @Test
    @Transactional
    @WithMockUser(roles = "USER")
    void createSupercomputer_shouldReturn201() throws Exception {
        Supercomputer newSc = new Supercomputer();
        newSc.setName("Test Supercomputer");
        newSc.setCountry("Russia");
        newSc.setContinent("Europe");
        newSc.setManufacturer("Test Corp");
        newSc.setRmaxTflops(1000.0);

        mockMvc.perform(post("/api/supercomputers")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(newSc)))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.id").exists())
                .andExpect(jsonPath("$.name").value("Test Supercomputer"));
    }

    @Test
    @WithMockUser(roles = "USER")
    void getSupercomputerById_notFound_shouldReturn404() throws Exception {
        mockMvc.perform(get("/api/supercomputers/non-existent-id"))
                .andExpect(status().isNotFound());
    }

    @Test
    @WithMockUser(roles = "USER")
    void deleteSupercomputer_notFound_shouldReturn404() throws Exception {
        mockMvc.perform(delete("/api/supercomputers/non-existent-id"))
                .andExpect(status().isNotFound());
    }

    @Test
    void accessWithoutAuth_shouldReturn401() throws Exception {
        mockMvc.perform(get("/api/supercomputers"))
                .andExpect(status().isUnauthorized());
    }

    @Test
    @WithMockUser(roles = "USER")
    void getSupercomputerById_shouldReturnSupercomputer() throws Exception {
        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä –∏–∑ –±–∞–∑—ã
        Supercomputer first = repository.findAll().iterator().next();

        mockMvc.perform(get("/api/supercomputers/{id}", first.getId()))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.id").value(first.getId()))
                .andExpect(jsonPath("$.name").value(first.getName()));
    }

    @Test
    @WithMockUser(roles = "USER")
    void updateSupercomputer_shouldReturn204() throws Exception {
        // –ü–æ–ª—É—á–∞–µ–º —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        Supercomputer existing = repository.findAll().iterator().next();
        existing.setName("Updated Name");

        mockMvc.perform(put("/api/supercomputers")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(existing)))
                .andExpect(status().isNoContent());
    }
}



FILE: src\test\java\com\utmn\shanaurin\supercomputers\controller\SupercomputerControllerTest.java


package com.utmn.shanaurin.supercomputers.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.utmn.shanaurin.supercomputers.model.Supercomputer;
import com.utmn.shanaurin.supercomputers.repository.SupercomputerJpaRepository;
import com.utmn.shanaurin.supercomputers.service.SupercomputerService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.context.annotation.Import;
import org.springframework.http.MediaType;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;

import java.util.Optional;

import static org.hamcrest.Matchers.is;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.BDDMockito.given;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(controllers = SupercomputerController.class,
        excludeAutoConfiguration = SecurityAutoConfiguration.class)
@Import(SupercomputerService.class)
class SupercomputerControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @MockitoBean
    private SupercomputerJpaRepository repository;

    @Test
    void add_shouldReturnCreated() throws Exception {
        Supercomputer newSc = new Supercomputer();
        newSc.setName("Test Supercomputer");
        newSc.setCountry("Russia");
        newSc.setRmaxTflops(1000.5);

        Supercomputer saved = new Supercomputer();
        saved.setId("generated-id");
        saved.setName("Test Supercomputer");
        saved.setCountry("Russia");
        saved.setRmaxTflops(1000.5);

        given(repository.save(any())).willReturn(saved);

        mockMvc.perform(post("/api/supercomputers")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(newSc)))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.id", is("generated-id")))
                .andExpect(jsonPath("$.name", is("Test Supercomputer")));
    }

    @Test
    void getOne_existingId_shouldReturnSupercomputer() throws Exception {
        Supercomputer sc = new Supercomputer();
        sc.setId("test-id-001");
        sc.setName("Fugaku");
        sc.setCountry("Japan");
        sc.setRmaxTflops(442010.0);

        given(repository.findById("test-id-001")).willReturn(Optional.of(sc));

        mockMvc.perform(get("/api/supercomputers/test-id-001"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.name", is("Fugaku")))
                .andExpect(jsonPath("$.country", is("Japan")))
                .andExpect(jsonPath("$.rmaxTflops", is(442010.0)));
    }

    @Test
    void getOne_nonExistingId_shouldReturn404() throws Exception {
        given(repository.findById("non-existent")).willReturn(Optional.empty());

        mockMvc.perform(get("/api/supercomputers/non-existent"))
                .andExpect(status().isNotFound());
    }

    @Test
    void delete_existingId_shouldReturn204() throws Exception {
        given(repository.existsById("test-id")).willReturn(true);

        mockMvc.perform(delete("/api/supercomputers/test-id"))
                .andExpect(status().isNoContent());
    }

    @Test
    void delete_nonExistingId_shouldReturn404() throws Exception {
        given(repository.existsById("non-existent")).willReturn(false);

        mockMvc.perform(delete("/api/supercomputers/non-existent"))
                .andExpect(status().isNotFound());
    }
}



FILE: src\test\java\com\utmn\shanaurin\supercomputers\service\DataInitializerServiceTest.java


package com.utmn.shanaurin.supercomputers.service;

import com.utmn.shanaurin.supercomputers.BaseIntegrationTest;
import com.utmn.shanaurin.supercomputers.repository.SupercomputerJpaRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;

import static org.assertj.core.api.Assertions.assertThat;

class DataInitializerServiceTest extends BaseIntegrationTest {

    @Autowired
    private DataInitializerService dataInitializerService;

    @Autowired
    private SupercomputerJpaRepository repository;

    @Test
    void csvDataShouldBeLoaded() {
        // –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        long count = repository.count();
        assertThat(count).isEqualTo(500); // –í CSV 501 –∑–∞–ø–∏—Å–µ–π
    }

    @Test
    void reloadDataFromCsv_shouldReloadData() {
        long initialCount = repository.count();
        dataInitializerService.reloadDataFromCsv();

        long afterReloadCount = repository.count();
        assertThat(afterReloadCount).isEqualTo(initialCount);
    }
}



FILE: src\test\java\com\utmn\shanaurin\supercomputers\service\SupercomputerServiceTest.java


package com.utmn.shanaurin.supercomputers.service;

import com.utmn.shanaurin.supercomputers.model.Supercomputer;
import com.utmn.shanaurin.supercomputers.repository.SupercomputerJpaRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.web.server.ResponseStatusException;

import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class SupercomputerServiceTest {

    @Mock
    private SupercomputerJpaRepository repository;

    @InjectMocks
    private SupercomputerService service;

    private Supercomputer fugaku;
    private Supercomputer summit;

    @BeforeEach
    void setUp() {
        fugaku = new Supercomputer();
        fugaku.setId("id-1");
        fugaku.setName("Fugaku");
        fugaku.setCountry("Japan");
        fugaku.setContinent("Asia");
        fugaku.setRmaxTflops(442010.0);

        summit = new Supercomputer();
        summit.setId("id-2");
        summit.setName("Summit");
        summit.setCountry("United States");
        summit.setContinent("North America");
        summit.setRmaxTflops(148600.0);
    }

    @Test
    void getAll_shouldReturnAllSupercomputers() {
        when(repository.findAll()).thenReturn(List.of(fugaku, summit));

        List<Supercomputer> result = (List<Supercomputer>) service.getAll();

        assertThat(result).hasSize(2);
        assertThat(result).extracting(Supercomputer::getName).containsExactly("Fugaku", "Summit");
        verify(repository).findAll();
    }

    @Test
    void getOne_existingId_shouldReturnSupercomputer() {
        when(repository.findById("id-1")).thenReturn(Optional.of(fugaku));

        Supercomputer result = service.getOne("id-1");

        assertThat(result.getName()).isEqualTo("Fugaku");
        verify(repository).findById("id-1");
    }

    @Test
    void getOne_nonExistingId_shouldThrowNotFoundException() {
        when(repository.findById("non-existent")).thenReturn(Optional.empty());

        assertThatThrownBy(() -> service.getOne("non-existent"))
                .isInstanceOf(ResponseStatusException.class)
                .hasMessageContaining("–Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    @Test
    void add_shouldSaveAndReturnSupercomputer() {
        Supercomputer newSc = new Supercomputer();
        newSc.setName("New Supercomputer");

        when(repository.save(any())).thenAnswer(invocation -> {
            Supercomputer saved = invocation.getArgument(0);
            saved.setId("generated-id");
            return saved;
        });

        Supercomputer result = service.add(newSc);

        assertThat(result.getId()).isEqualTo("generated-id");
        assertThat(result.getName()).isEqualTo("New Supercomputer");
        verify(repository).save(any());
    }

    @Test
    void update_existingId_shouldUpdate() {
        when(repository.existsById("id-1")).thenReturn(true);
        when(repository.save(fugaku)).thenReturn(fugaku);

        service.update(fugaku);

        verify(repository).existsById("id-1");
        verify(repository).save(fugaku);
    }

    @Test
    void update_nonExistingId_shouldThrowNotFoundException() {
        Supercomputer sc = new Supercomputer();
        sc.setId("non-existent");

        when(repository.existsById("non-existent")).thenReturn(false);

        assertThatThrownBy(() -> service.update(sc))
                .isInstanceOf(ResponseStatusException.class)
                .hasMessageContaining("–Ω–µ –Ω–∞–π–¥–µ–Ω");

        verify(repository, never()).save(any());
    }

    @Test
    void delete_existingId_shouldDelete() {
        when(repository.existsById("id-1")).thenReturn(true);
        doNothing().when(repository).deleteById("id-1");

        service.delete("id-1");

        verify(repository).existsById("id-1");
        verify(repository).deleteById("id-1");
    }

    @Test
    void delete_nonExistingId_shouldThrowNotFoundException() {
        when(repository.existsById("non-existent")).thenReturn(false);

        assertThatThrownBy(() -> service.delete("non-existent"))
                .isInstanceOf(ResponseStatusException.class)
                .hasMessageContaining("–Ω–µ –Ω–∞–π–¥–µ–Ω");

        verify(repository, never()).deleteById(any());
    }

    @Test
    void avgPerformance_shouldReturnAverage() {
        when(repository.getAvgPerformance()).thenReturn(295305.0);

        Double result = service.avgPerformance();

        assertThat(result).isEqualTo(295305.0);
        verify(repository).getAvgPerformance();
    }

    @Test
    void getByCountry_shouldReturnFilteredList() {
        when(repository.findByCountryIgnoreCase("Japan")).thenReturn(List.of(fugaku));

        List<Supercomputer> result = service.getByCountry("Japan");

        assertThat(result).hasSize(1);
        assertThat(result.get(0).getName()).isEqualTo("Fugaku");
    }

    @Test
    void countByContinent_shouldReturnMap() {
        when(repository.countByContinent()).thenReturn(List.of(
                new Object[]{"Asia", 5L},
                new Object[]{"North America", 3L}
        ));

        var result = service.countByContinent();

        assertThat(result).containsEntry("Asia", 5L);
        assertThat(result).containsEntry("North America", 3L);
    }
}


